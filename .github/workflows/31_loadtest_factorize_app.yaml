name: 30 Load Test Factorize App (with JMeter)

on:
  workflow_dispatch:
    inputs:
      resource_group:
        description: "Azure Resource Group Name"
        required: true
        default: "rg-taras-aks-t-eu"
      cluster_name:
        description: "AKS Cluster Name"
        required: true
        default: "aks-taras-aks-t-eu"

jobs:
  loadtest_factorize_app:
    runs-on: ubuntu-latest
    env:
      AKS_NAMESPACE: apps-test
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: AZ and AKS Login and Setup
        uses: ./.github/actions/az-aks-commons
        with:
          azure_tenant_id: ${{ vars.AZURE_TENANT_ID }}
          azure_subscription_id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          azure_sp_client_id: ${{ vars.AZURE_SP_CLIENT_ID }}
          resource_group: ${{ github.event.inputs.resource_group }}
          cluster_name: ${{ github.event.inputs.cluster_name }}
          azure_sp_client_secret: ${{ secrets.AZURE_SP_CLIENT_SECRET }}

      - name: Get Factorize APP Host IP Address
        id: get-ip
        run: |
          export FACTORIZE_APP_HOST_IP=$(kubectl get ingress ingress-controller -n ${{ env.AKS_NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "SQRT APP Host IP: $FACTORIZE_APP_HOST_IP"
          echo "factorize_app_host_ip=$FACTORIZE_APP_HOST_IP" >> $GITHUB_OUTPUT

      - name: Install JMeter
        id: install-jmeter
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jdk wget
          wget https://downloads.apache.org//jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          JMETER_HOME=$PWD/apache-jmeter-5.6.3
          echo "jmeter_home=$JMETER_HOME" >> $GITHUB_OUTPUT
          echo "new_path=$JMETER_HOME/bin:$PATH" >> $GITHUB_OUTPUT

      - name: Run JMeter Load Test
        env:
          JMETER_HOME: ${{ steps.install-jmeter.outputs.jmeter_home }}
          PATH: ${{ steps.install-jmeter.outputs.new_path }}
          FACTORIZE_APP_HOST_IP: ${{ steps.get-ip.outputs.factorize_app_host_ip }}
        run: |
          cd testing/load/jmeter/factorize-app
          TEST_FILE=factorize_app_600s-duration_50-threads-max_300s-rampup.jmx

          echo "Using test file: $TEST_FILE"
          echo "SQRT APP Host IP: $FACTORIZE_APP_HOST_IP"

          jmeter -n -t $TEST_FILE -l results.jtl -JHOST=$FACTORIZE_APP_HOST_IP -e -o report
          cd - >> /dev/null

      - name: Upload JMeter report
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report
          path: testing/load/jmeter/factorize-app/report
